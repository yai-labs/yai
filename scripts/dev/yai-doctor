#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source "$ROOT/scripts/dev/resolve-yai-bin.sh"
BIN="$(yai_resolve_bin "$ROOT" || true)"
WS_DEFAULT="${YAI_WS_DEFAULT:-dev}"

echo "=== YAI Doctor"
echo "root: ${ROOT}"

echo "=== Binaries"
DIST_BIN="$ROOT/dist/bin"
LEGACY_BIN="${HOME}/.yai/artifacts/yai-core/bin"

for f in "${DIST_BIN}/yai-boot" "${DIST_BIN}/yai-kernel" "${DIST_BIN}/yai-engine" "${DIST_BIN}/yai-root-server"; do
  [[ -x "${f}" ]] && echo "OK: ${f}" || echo "MISSING: ${f}"
done

for f in "${LEGACY_BIN}/yai-boot" "${LEGACY_BIN}/yai-kernel" "${LEGACY_BIN}/yai-engine"; do
  [[ -x "${f}" ]] && echo "LEGACY_OK: ${f}" || true
done

echo "=== yai in PATH"
if [[ -n "$BIN" ]]; then
  echo "OK: $(command -v yai)"
  "$BIN" status --ws "${WS_DEFAULT}" || true
  "$BIN" monitor --help >/dev/null 2>&1 && echo "OK: monitor command available"
else
  echo "MISSING: yai not found in PATH"
fi

echo "=== Duplicate yai binaries (artifacts)"
find "${HOME}/.yai/artifacts" -type f -name "yai" -perm -111 -print || true

echo "OK: doctor complete"
