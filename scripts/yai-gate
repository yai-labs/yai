#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
GATES_DIR="$ROOT/scripts/gates"

usage() {
  cat <<'EOF'
Usage:
  scripts/yai-gate list
  scripts/yai-gate <gate-name> [args...]

Examples:
  scripts/yai-gate ws dev
  scripts/yai-gate graph graph_gate
EOF
}

list_gates() {
  find "$GATES_DIR" -maxdepth 1 -type f -name "*.sh" -print \
    | sed -e "s#^$GATES_DIR/##" -e 's/\.sh$//' \
    | sort
}

if [[ "${1:-}" == "" ]]; then
  usage
  exit 1
fi

if [[ "${1:-}" == "list" ]]; then
  list_gates
  exit 0
fi

NAME="$1"
shift
TARGET="$GATES_DIR/$NAME.sh"
if [[ ! -x "$TARGET" ]]; then
  echo "FAIL: unknown gate '$NAME'"
  echo "Available gates:"
  list_gates
  exit 1
fi

exec "$TARGET" "$@"
