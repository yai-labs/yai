name: pr-milestone-sync

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  issues: read
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync PR milestone (and optional track/phase labels) from linked issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            const body = pr.body || "";

            // Supports:
            // - Closes #123 / Fixes #123 / Resolves #123
            // - full issue URLs
            const issueRefs = new Set();
            const closeRe = /\b(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+(?:#(\d+)|https:\/\/github\.com\/[^/\s]+\/[^/\s]+\/issues\/(\d+))/gi;
            let m;
            while ((m = closeRe.exec(body)) !== null) {
              const n = m[1] || m[2];
              if (n) issueRefs.add(Number(n));
            }

            if (issueRefs.size === 0) {
              core.info("No closing issue reference found in PR body; skipping milestone sync.");
              return;
            }

            const issueNumber = [...issueRefs][0];
            core.info(`Using linked issue #${issueNumber} for milestone sync`);

            const { data: issue } = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber,
            });

            if (!issue.milestone) {
              core.info(`Issue #${issueNumber} has no milestone; skipping milestone sync.`);
              return;
            }

            const targetMilestone = issue.milestone.number;
            const currentMilestone = pr.milestone ? pr.milestone.number : null;
            if (currentMilestone === targetMilestone) {
              core.info(`PR milestone already aligned to '${issue.milestone.title}'.`);
            } else {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: pr.number,
                milestone: targetMilestone,
              });
              core.info(`PR milestone set to '${issue.milestone.title}' from issue #${issueNumber}.`);
            }

            // Optional: copy track:/phase: labels from issue to PR if labels exist in repo.
            const source = (issue.labels || [])
              .map((l) => (typeof l === "string" ? l : l?.name))
              .filter((x) => typeof x === "string")
              .filter((x) => x.startsWith("track:") || x.startsWith("phase:"));

            if (source.length === 0) {
              core.info("No track:/phase: labels to copy.");
              return;
            }

            const repoLabels = await github.paginate(github.rest.issues.listLabelsForRepo, {
              owner,
              repo,
              per_page: 100,
            });
            const repoLabelSet = new Set(repoLabels.map((l) => l.name));
            const toAdd = [...new Set(source)].filter((name) => repoLabelSet.has(name));

            if (toAdd.length === 0) {
              core.info("track:/phase: labels found on issue but missing in repo; skipping label copy.");
              return;
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr.number,
              labels: toAdd,
            });
            core.info(`Copied labels to PR: ${toAdd.join(", ")}`);
