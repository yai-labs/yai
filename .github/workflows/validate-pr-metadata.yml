name: validate-pr-metadata

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  pr-metadata:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title + body fields
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title || "";
            const body  = pr.body  || "";

            function fail(msg) {
              core.setFailed(msg);
            }

            // 1) Title must be conventional-ish
            const titleOk = /^(feat|fix|docs|chore|refactor|test|build|ci)(\([^)]+\))?:\s.+/.test(title);
            if (!titleOk) {
              fail("PR title must match: type(scope): subject  (e.g. docs(governance): add templates)");
              return;
            }

            // 2) Must contain required sections
            const requiredBlocks = [
              { re: /##\s+IDs\b/, msg: "Missing '## IDs' section in PR body." },
              { re: /##\s+Objective\b/, msg: "Missing '## Objective' section in PR body." },
              { re: /##\s+Evidence\b/, msg: "Missing '## Evidence' section in PR body." },
              { re: /##\s+Commands run\b/, msg: "Missing '## Commands run' section in PR body." },
              { re: /```bash[\s\S]*```/, msg: "Commands run must include a ```bash code block```." },
            ];

            for (const r of requiredBlocks) {
              if (!r.re.test(body)) {
                fail(r.msg);
                return;
              }
            }

            // 3) IDs fields
            const issueLine = body.match(/Issue-ID:\s*(.+)/i);
            if (!issueLine) {
              fail("Missing 'Issue-ID:' line in ## IDs.");
              return;
            }

            const issueVal = (issueLine[1] || "").trim();
            const isIssueNumber = /^#\d+$/.test(issueVal);
            const isNA = /^N\/A$/i.test(issueVal) || /^NA$/i.test(issueVal);

            if (!isIssueNumber && !isNA) {
              fail("Issue-ID must be '#<number>' or 'N/A'.");
              return;
            }

            if (isNA) {
              const reasonOk = /Issue-Reason\s*\(required if N\/A\):\s*\S+/i.test(body) || /Issue-Reason:\s*\S+/i.test(body);
              if (!reasonOk) {
                fail("Issue-ID is N/A but Issue-Reason is missing or empty.");
                return;
              }
            }

            const baseCommitOk = /Base-Commit:\s*[0-9a-f]{40}/i.test(body);
            if (!baseCommitOk) {
              fail("Missing or invalid 'Base-Commit:' (must include a 40-char SHA).");
              return;
            }

            core.info("PR metadata validation: OK");
