name: validate-pr-metadata

on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review]

jobs:
  pr-metadata:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Validate PR body metadata and placeholder ban
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";

            function fail(msg) { core.setFailed(msg); }

            // must contain PR-METADATA yaml block
            if (!body.includes("## PR-METADATA") || !body.includes("```yaml")) {
              return fail("Missing PR-METADATA yaml block (see templates).");
            }

            // extract YAML block (best-effort)
            const match = body.match(/## PR-METADATA\s*```yaml([\s\S]*?)```/m);
            if (!match) return fail("PR-METADATA block not found or malformed.");
            const yamlBlock = match[1];

            // required keys (simple presence check)
            const required = ["yai_pr:", "type:", "base_commit:", "compatibility:", "repos_impacted:"];
            const missing = required.filter(k => !yamlBlock.includes(k));
            if (missing.length) {
              return fail("PR-METADATA missing keys: " + missing.join(", "));
            }

            // ban placeholders
            const banned = [
              "<40-char-sha>",
              "#<issue-number>",
              "MP-<TRACK>-<X.Y.Z>",
              "docs/runbooks/<name>.md",
              "<link>|N/A",
              "[bug] <short>",
              "[feat] <short>"
            ];
            const hit = banned.filter(x => body.includes(x));
            if (hit.length) {
              return fail("Placeholders left in PR body: " + hit.join(", "));
            }

            // require Commands run section
            if (!body.includes("## Commands run")) {
              return fail("Missing '## Commands run' section.");
            }

            // minimal sanity for base_commit value (40 hex somewhere)
            const shaMatch = body.match(/base_commit:\s*\"?([0-9a-f]{40})\"?/i);
            if (!shaMatch) {
              return fail("base_commit must be a 40-char git SHA in PR-METADATA.");
            }
