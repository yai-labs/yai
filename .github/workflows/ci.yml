name: ci

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-linux:
    name: Build and verify (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential make python3 doxygen

      - name: Build
        run: make all

      - name: Verify generated artifacts
        run: bash scripts/dev/check-generated.sh

      - name: Build docs
        run: make docs

  build-arch:
    name: Build and verify (Arch)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install toolchain
        run: |
          pacman -Syu --noconfirm --needed ca-certificates git base-devel make python doxygen

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build
        run: make all

      - name: Verify generated artifacts
        run: bash scripts/dev/check-generated.sh

  build-debian:
    name: Build and verify (Debian)
    runs-on: ubuntu-latest
    container:
      image: debian:stable
    steps:
      - name: Install toolchain
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y ca-certificates git build-essential make python3 doxygen

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build
        run: make all

      - name: Verify generated artifacts
        run: bash scripts/dev/check-generated.sh

  build-fedora:
    name: Build and verify (Fedora)
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - name: Install toolchain
        run: |
          dnf install -y git make gcc gcc-c++ python3 doxygen

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build
        run: make all

      - name: Verify generated artifacts
        run: bash scripts/dev/check-generated.sh

  build-macos:
    name: Build (macOS ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build
        run: make all

      - name: Verify generated artifacts
        run: bash scripts/dev/check-generated.sh
